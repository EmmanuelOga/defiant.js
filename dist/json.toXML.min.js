/*
 * defiant.js [v1.3.4]
 * http://www.defiantjs.com 
 * Copyright (c) 2013-2015, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License
 */
JSON.toXML||(JSON.toXML=function(t,r){"use strict";var a,s,n,e={map:[],rx_validate_name:/^(?!xml)[a-z_][\w\d.:]*$/i,rx_node:/<(.+?)( .*?)>/,rx_constructor:/<(.+?)( d:contr=".*?")>/,rx_namespace:/ xmlns\:d="defiant\-namespace"/,rx_data:/(<.+?>)(.*?)(<\/d:data>)/i,rx_function:/function (\w+)/i,namespace:'xmlns:d="defiant-namespace"',to_xml_str:function(t){return{str:this.hash_to_xml(null,t),map:this.map}},hash_to_xml:function(t,r,a){var s,n,e,c,l,i,o,h,u=r.constructor===Array,m=[],p=[];for(s in r)if(n=r[s],(null===n||void 0===n||"NaN"===n.toString())&&(n=null),c="@"===s.slice(0,1),l=a?t:s,l==+l&&r.constructor!==Object&&(l="d:item"),null===n?(i=null,o=!1):(i=n.constructor,o=i.toString().match(this.rx_function)[1]),c)p.push(l.slice(1)+'="'+this.escape_xml(n)+'"'),"String"!==o&&p.push("d:"+l.slice(1)+'="'+o+'"');else if(null===n)m.push(this.scalar_to_xml(l,n));else switch(i){case Function:throw"JSON data should not contain functions. Please check jour structure.";case Object:m.push(this.hash_to_xml(l,n));break;case Array:if(s===l){if(e=n.constructor===Array)for(h=n.length;h--;)null!==n[h]&&n[h]&&n[h].constructor!==Array||(e=!0),e||n[h].constructor!==Object||(e=!0);m.push(this.scalar_to_xml(l,n,e));break}case String:if("string"==typeof n&&(n=n.toString().replace(/\&/g,"&amp;").replace(/\r|\n/g,"&#13;")),"#text"===l){this.map.push(r),p.push('d:mi="'+this.map.length+'"'),p.push('d:constr="'+o+'"'),m.push(this.escape_xml(n));break}case Number:case Boolean:if("#text"===l&&"String"!==o){this.map.push(r),p.push('d:mi="'+this.map.length+'"'),p.push('d:constr="'+o+'"'),m.push(this.escape_xml(n));break}m.push(this.scalar_to_xml(l,n))}return t||(t="d:data",p.push(this.namespace),u&&p.push('d:constr="Array"')),null===t.match(this.rx_validate_name)&&(p.push('d:name="'+t+'"'),t="d:name"),a?m.join(""):(this.map.push(r),p.push('d:mi="'+this.map.length+'"'),"<"+t+(p.length?" "+p.join(" "):"")+(m.length?">"+m.join("")+"</"+t+">":"/>"))},scalar_to_xml:function(t,r,a){var s,n,e,c="";if(null===t.match(this.rx_validate_name)&&(c+=' d:name="'+t+'"',t="d:name",a=!1),(null===r||"NaN"===r.toString())&&(r=null),null===r)return"<"+t+' d:constr="null"/>';if(1===r.length&&r[0].constructor===Object){s=this.hash_to_xml(!1,r[0]);var l=s.match(this.rx_node),i=s.match(this.rx_constructor);return l=null!==l?l[2].replace(this.rx_namespace,"").replace(/>/,"").replace(/"\/$/,'"'):"",i=null!==i?i[2]:"",s=s.match(this.rx_data),s=null!==s?s[2]:"","<"+t+l+" "+i+' d:type="ArrayItem">'+s+"</"+t+">"}return 0===r.length&&r.constructor===Array?"<"+t+' d:constr="Array"/>':a?this.hash_to_xml(t,r,!0):(n=r.constructor,e=n.toString().match(this.rx_function)[1],s=n===Array?this.hash_to_xml("d:item",r,!0):this.escape_xml(r),c+=' d:constr="'+e+'"',this.map.push(r),c+=' d:mi="'+this.map.length+'"',"#text"===t?this.escape_xml(r):"<"+t+c+">"+s+"</"+t+">")},escape_xml:function(t){return String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/&nbsp;/g,"&#160;")}};switch(typeof r){case"function":return n=x10.compile(e),void n.to_xml_str(t,function(a){r({doc:Defiant.xmlFromString(a.str),src:t,map:a.map})});case"boolean":return a=e.to_xml_str.call(e,t),{doc:Defiant.xmlFromString(a.str),src:t,map:a.map};default:return a=e.to_xml_str.call(e,t),s=Defiant.xmlFromString(a.str),this.search.map=a.map,s}});